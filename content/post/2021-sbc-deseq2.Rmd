---
title: "SBC & DESeq2"
date: 2021-09-23
tags: ["R","Stan","SBC"]
draft: TRUE
---
  
Let's setup the environment.

```{r setup, message=FALSE,warning=FALSE, results="hide"}
library(SBC)
library(ggplot2)

# Bioconductor packages
library(DESeq2) 
library(apeglm)

# Setup multiprocessing
library(future)
plan(tweak(multisession, workers = 4))

theme_set(cowplot::theme_cowplot())

# Setup caching of results
cache_dir <- "./_sbc_deseq2_cache/"
if(!dir.exists(cache_dir)) {
  dir.create(cache_dir)
}

```

```{r}
SBC_backend_DESeq2 <- function(shrink_type = "normal", ..., useT = FALSE) {
    shrink_args = list(...)
    if(any(names(shrink_args) %in% c("coef", "contrast", "type"))) {
      #TODO better report error
      stop(paste0("Parameter 'TODO' cannot be provided when defining DESeq2 backend, must be passed other way"))
    }
  
    structure(list(shrink_type = shrink_type, 
                   shrink_args = shrink_args,
                   useT = useT), class = "SBC_backend_DEseq2")
}

SBC_fit.SBC_backend_DEseq2 <- function(backend, generated, cores) {
  colData <- data.frame(group = factor(rep(c("A", "B"), each = generated$N_per_group)))
  dds <- DESeq2::DESeqDataSetFromMatrix(countData = generated$countData,
                              colData = colData,
                              design = ~ group)
  
  DESeq2::sizeFactors(dds) <- rep(1, generated$N_per_group * 2)
  
  dds <- DESeq2::DESeq(dds, fitType = "parametric", 
                       minReplicatesForReplace = Inf, minmu = 1e-10,
                       useT = backend$useT)
  
#  if(backend$shrink_type != "none") {
  # } else {
  #   res <- DESeq2::results()
  # }

  structure( list(
    dds = dds,
    backend = backend),
    class = "SBC_fit_DESeq2"
  )  
  
}

SBC_fit_to_draws_matrix.SBC_fit_DESeq2 <- function(fit) {
  if(fit$backend$shrink_type != "none") {
    res <- do.call(DESeq2::lfcShrink,
                 c(list(dds = fit$dds, coef = "group_B_vs_A", 
                        type = fit$backend$shrink_type),
                   fit$backend$shrink_args))
  } else {
    res <- DESeq2::results(fit$dds, contrast = c("group", "B", "A"))
  }

  n_samps <- 1000
  
  useT <- "tDegreesFreedom" %in% names(S4Vectors::mcols(fit$dds))
  if(useT) {
    df <- unique(S4Vectors::mcols(fit$dds)$tDegreesFreedom)
    if(length(df) > 1) {
      stop("Non-unique DF")
    }
    base_samps <- rt(n_samps * nrow(res), df = df)
  } else {
    base_samps <- rnorm(n_samps * nrow(res))
  }
  beta_samps <- matrix(res$log2FoldChange, nrow = n_samps, ncol = nrow(res),  byrow = TRUE) +
      matrix(base_samps, nrow = n_samps, ncol = nrow(res)) *
       matrix(res$lfcSE, nrow = n_samps, ncol = nrow(res),  byrow = TRUE)

  posterior::as_draws_matrix(posterior::draws_rvars(beta = posterior::rvar(beta_samps)))
}
```





```{r}
SBC_backend_iid_draws.SBC_backend_DEseq2 <- function(backend) {
  TRUE
}
```


```{r}
generator_single_DEseq2 <- function(N_per_group,
                                    N_genes, 
                                    intercept_prior_mean = 4, 
                                    intercept_prior_sd = 2, 
                                    predictor_prior_sd = 1) {
  
  asymptDisp <- rgamma(1, shape = 3, rate = 6)
  extraPois <- rgamma(1, shape = 4, rate = 2.3)
  disp_sd = abs(rnorm(1,0,1))

  countData <- matrix(NA_integer_, nrow = N_genes, ncol = 2 * N_per_group)
  X <- rep(c(0, 1), each = N_per_group)
  
  
  # Do rejection sampling to avoid all zero rows
  needs_recomputing <- rep(TRUE, N_genes)

  intercept <- array(NA_real_, N_genes)
  beta <- array(NA_real_, N_genes)

  repeat {   
    N_recomputing <- sum(needs_recomputing)
    intercept[needs_recomputing] <- rnorm(N_recomputing, intercept_prior_mean, intercept_prior_sd)
    beta[needs_recomputing] <- rnorm(N_recomputing, 0, predictor_prior_sd)

    mean_expr <- 2^intercept + 0.5 * (2^beta)
    disp_mean <-  extraPois/mean_expr + asymptDisp
    dispersions <- rlnorm(N_recomputing, disp_mean, disp_sd)

    for(samp in 1:(2 * N_per_group)) {
      logmus <- intercept[needs_recomputing] + beta[needs_recomputing] * X[samp]
      mus <- 2^logmus
      countData[needs_recomputing, samp] <- rnbinom(N_recomputing, mu = mus, size = 1/dispersions)
    }
    needs_recomputing <- rowSums(countData) == 0
    if(!any(needs_recomputing)) {
      break;
    }
  }
  
  rownames(countData) <- paste0("g", 1:N_genes)
  
  list(
    variables = list(beta = beta),
    generated = list(N_per_group = N_per_group, countData = countData)
  ) 
}
```


```{r}
set.seed(43216842)
datasets20 <- generate_datasets(SBC_generator_function(
   generator_single_DEseq2, N_per_group = 20, N_genes = 1000),
   n_sims = 1000) 
```


```{r}
res20 <- compute_SBC(datasets20, SBC_backend_DESeq2(),
                         keep_fits = FALSE,
                         globals = c("SBC_fit.SBC_backend_DEseq2", 
                                     "SBC_fit_to_draws_matrix.SBC_fit_DESeq2",
                                     "SBC_backend_iid_draws.SBC_backend_DEseq2"),
                         cache_mode = "results", cache_location = file.path(cache_dir, "SBC_20"))
```


```{r}
pars_to_show <- paste0("beta[", sample(1:1000, size = 12), "]")
plot_rank_hist(res20, variables = pars_to_show)
plot_ecdf_diff(res20, variables = pars_to_show)
plot_sim_estimated(res20, variables = pars_to_show)
plot_coverage(res20, variables = pars_to_show)
```


```{r}
set.seed(26845214)
datasets3 <- generate_datasets(SBC_generator_function(
   generator_single_DEseq2, N_per_group = 3, N_genes = 1000),
   n_sims = 1000) 
```


```{r}
res3 <- compute_SBC(datasets3, SBC_backend_DESeq2(), globals = c("SBC_fit.SBC_backend_DEseq2", "SBC_fit_to_draws_matrix.SBC_fit_DESeq2",
                                                          "SBC_backend_iid_draws.SBC_backend_DEseq2"),
                         cache_mode = "results", cache_location = file.path(cache_dir, "SBC_3"),
                        keep_fits = FALSE)
```


```{r}
pars_to_show <- paste0("beta[", sample(1:1000, size = 12), "]")
plot_rank_hist(res3, variables = pars_to_show)
plot_ecdf_diff(res3, variables = pars_to_show)
plot_sim_estimated(res3, variables = pars_to_show)
plot_coverage(res3, variables = pars_to_show)
```

```{r}
cov_3 <- empirical_coverage(res3$stats, width = 0.95)
hist(cov_3$estimate)
hist(cov_3$ci_low)
```


```{r}
res3_t <- compute_SBC(datasets3, SBC_backend_DESeq2(useT = TRUE), globals = c("SBC_fit.SBC_backend_DEseq2", "SBC_fit_to_draws_matrix.SBC_fit_DESeq2",
                                                          "SBC_backend_iid_draws.SBC_backend_DEseq2"),
                         cache_mode = "results", cache_location = file.path(cache_dir, "SBC_3_T"),
                        keep_fits = FALSE)
```


```{r}
pars_to_show <- paste0("beta[", sample(1:1000, size = 12), "]")
plot_rank_hist(res3_t, variables = pars_to_show)
plot_ecdf_diff(res3_t, variables = pars_to_show)
plot_sim_estimated(res3_t, variables = pars_to_show)
plot_coverage(res3_t, variables = pars_to_show)
```


```{r}
res3_none <- compute_SBC(datasets3, SBC_backend_DESeq2(shrink_type = "none"), globals = c("SBC_fit.SBC_backend_DEseq2", "SBC_fit_to_draws_matrix.SBC_fit_DESeq2",
                                                          "SBC_backend_iid_draws.SBC_backend_DEseq2"),
                         cache_mode = "results", cache_location = file.path(cache_dir, "SBC_3_none"),
                        keep_fits = FALSE)

```


```{r}
pars_to_show <- paste0("beta[", sample(1:1000, size = 12), "]")
plot_rank_hist(res3_none, variables = pars_to_show)
plot_ecdf_diff(res3_none, variables = pars_to_show)
plot_sim_estimated(res3_none, variables = pars_to_show)
plot_coverage(res3_none, variables = pars_to_show)
```

```{r}
res20_apeglm <- compute_SBC(datasets20, SBC_backend_DESeq2(shrink_type = "apeglm"), globals = c("SBC_fit.SBC_backend_DEseq2", "SBC_fit_to_draws_matrix.SBC_fit_DESeq2",
                                                          "SBC_backend_iid_draws.SBC_backend_DEseq2"),
                         cache_mode = "results", cache_location = file.path(cache_dir, "SBC_20_apeglm"),
                        keep_fits = FALSE)
```

```{r}
library(tidyverse)
save_dir <- "_sbc_deseq2_cache/"

rank_hist_1 <- plot_rank_hist(res20_apeglm, variables = "beta[109]")
ggsave(file.path(save_dir, "20_rank_hist1.png"), rank_hist_1)
plot_ecdf_diff(res20_apeglm, variables = "beta[109]")
ggsave(file.path(save_dir, "20_ecdf_diff1.png"))
plot_coverage(res20_apeglm, variables = "beta[109]")
ggsave(file.path(save_dir, "20_coverage1.png"))

empirical_coverage(res20_apeglm$stats %>% filter(variable == "beta[109]"),width = c(0.5,0.9,0.95))
empirical_coverage(res20_apeglm$stats %>% filter(variable == "beta[108]"),width = c(0.5,0.9,0.95))
```


```{r}
pars_to_show <- paste0("beta[", sample(1:1000, size = 12), "]")
plot_rank_hist(res20_apeglm, variables = pars_to_show)
ggsave(file.path(save_dir, "20_rank_hist_many.png"))
plot_ecdf_diff(res20_apeglm, variables = pars_to_show)
ggsave(file.path(save_dir, "20_ecdf_diff_many.png"))
plot_coverage(res20_apeglm, variables = pars_to_show)
ggsave(file.path(save_dir, "20_coverage_many.png"))
plot_sim_estimated(res20_apeglm, variables = pars_to_show, alpha = 0.1)
ggsave(file.path(save_dir, "20_sim_estimated_many.png"))

```


```{r}
res3_apeglm <- compute_SBC(datasets3, SBC_backend_DESeq2(shrink_type = "apeglm"), globals = c("SBC_fit.SBC_backend_DEseq2", "SBC_fit_to_draws_matrix.SBC_fit_DESeq2",
                                                          "SBC_backend_iid_draws.SBC_backend_DEseq2"),
                         cache_mode = "results", cache_location = file.path(cache_dir, "SBC_3_apeglm"),
                        keep_fits = FALSE)
```
```{r}
rank_hist_1 <- plot_rank_hist(res3_apeglm, variables = "beta[745]")
ggsave(file.path(save_dir, "3_rank_hist1.png"), rank_hist_1)
plot_ecdf_diff(res3_apeglm, variables = "beta[745]")
ggsave(file.path(save_dir, "3_ecdf_diff1.png"))
plot_coverage(res3_apeglm, variables = "beta[745]")
ggsave(file.path(save_dir, "3_coverage1.png"))

empirical_coverage(res3_apeglm$stats %>% filter(variable == "beta[745]"), c(0.5,0.9,0.95))

```


```{r}
pars_to_show <- paste0("beta[", sample(1:1000, size = 12), "]")
plot_rank_hist(res3_apeglm, variables = pars_to_show)
ggsave(file.path(save_dir, "3_rank_hist_many.png"))
plot_ecdf_diff(res3_apeglm, variables = pars_to_show)
ggsave(file.path(save_dir, "3_ecdf_diff_many.png"))
plot_sim_estimated(res3_apeglm, variables = pars_to_show)
ggsave(file.path(save_dir, "3_sim_estimated_many.png"))
plot_coverage(res3_apeglm, variables = pars_to_show)
ggsave(file.path(save_dir, "3_coverage_many.png"))
```


  