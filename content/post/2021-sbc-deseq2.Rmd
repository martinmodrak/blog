---
title: "SBC & DESeq2"
date: 2021-09-23
tags: ["R","Stan","SBC"]
draft:TRUE
---
  
Let's setup the environment.

```{r setup, message=FALSE,warning=FALSE, results="hide"}
library(SBC)
library(ggplot2)
library(DESeq2)

library(future)
plan(multisession)

# Setup caching of results
cache_dir <- "./cache/"
if(!dir.exists(cache_dir)) {
  dir.create(cache_dir)
}

```

```{r}
SBC_backend_DESeq2 <- function(shrink_type = "normal", ...) {
    shrink_args = list(...)
    if(any(names(shrink_args) %in% c("coef", "contrast", "type"))) {
      #TODO better report error
      stop(paste0("Parameter 'TODO' cannot be provided when defining DESeq2 backend, must be passed other way"))
    }
  
    structure(list(shrink_type = shrink_type, 
                   shrink_args = shrink_args), class = "SBC_backend_DEseq2")
}

SBC_fit.SBC_backend_DEseq2 <- function(backend, generated, cores) {
  colData <- data.frame(group = factor(rep(c("A", "B"), each = generated$N_per_group)))
  dds <- DESeq2::DESeqDataSetFromMatrix(countData = generated$countData,
                              colData = colData,
                              design = ~ group)
  
  DESeq2::sizeFactors(dds) <- rep(1, generated$N_per_group * 2)
  
  dds <- DESeq2::DESeq(dds, fitType = "parametric", 
                       minReplicatesForReplace = Inf, minmu = 1e-10)
  
#  if(backend$shrink_type != "none") {
  # } else {
  #   res <- DESeq2::results()
  # }

  structure( list(
    dds = dds,
    backend = backend),
    class = "SBC_fit_DESeq2"
  )  
  
}

SBC_fit_to_draws_matrix.SBC_fit_DESeq2 <- function(fit) {
  res <- do.call(DESeq2::lfcShrink,
               c(list(dds = fit$dds, coef = "group_B_vs_A", 
                      type = fit$backend$shrink_type),
                 fit$backend$shrink_args))

  n_samps <- 200

  beta_samps <- matrix(res$log2FoldChange, nrow = n_samps, ncol = nrow(res),  byrow = TRUE) +
      matrix(rnorm(n_samps * nrow(res)), nrow = n_samps, ncol = nrow(res)) *
       matrix(res$lfcSE, nrow = n_samps, ncol = nrow(res),  byrow = TRUE)

  posterior::as_draws_matrix(posterior::draws_rvars(beta = posterior::rvar(beta_samps)))
}
```




```{r}
SBC_backend_iid_samples.SBC_backend_DEseq2 <- function(backend) {
  TRUE
}
```


```{r}
generator_single_DEseq2 <- function(N_per_group,
                                    N_genes, 
                                    intercept_prior_mean = 4, 
                                    intercept_prior_sd = 2, 
                                    predictor_prior_sd = 1) {
  
  asymptDisp <- rgamma(1, shape = 3, rate = 6)
  extraPois <- rgamma(1, shape = 4, rate = 2.3)
  disp_sd = abs(rnorm(1,0,1))

  countData <- matrix(NA_integer_, nrow = N_genes, ncol = 2 * N_per_group)
  X <- rep(c(0, 1), each = N_per_group)
  
  
  # Do rejection sampling to avoid all zero rows
  needs_recomputing <- rep(TRUE, N_genes)

  intercept <- array(NA_real_, N_genes)
  beta <- array(NA_real_, N_genes)

  repeat {   
    N_recomputing <- sum(needs_recomputing)
    intercept[needs_recomputing] <- rnorm(N_recomputing, intercept_prior_mean, intercept_prior_sd)
    beta[needs_recomputing] <- rnorm(N_recomputing, 0, predictor_prior_sd)

    mean_expr <- 2^intercept + 0.5 * (2^beta)
    disp_mean <-  extraPois/mean_expr + asymptDisp
    dispersions <- rlnorm(N_recomputing, disp_mean, disp_sd)

    for(samp in 1:(2 * N_per_group)) {
      logmus <- intercept[needs_recomputing] + beta[needs_recomputing] * X[samp]
      mus <- 2^logmus
      countData[needs_recomputing, samp] <- rnbinom(N_recomputing, mu = mus, size = 1/dispersions)
    }
    needs_recomputing <- rowSums(countData) == 0
    if(!any(needs_recomputing)) {
      break;
    }
  }
  
  rownames(countData) <- paste0("g", 1:N_genes)
  
  list(
    parameters = list(beta = beta),
    generated = list(N_per_group = N_per_group, countData = countData)
  ) 
}
```


```{r}
set.seed(43216842)
datasets20 <- generate_datasets(SBC_generator_function(
   generator_single_DEseq2, N_per_group = 20, N_genes = 1000),
   n_datasets = 100) 
```


```{r}
res20 <- compute_results(datasets, SBC_backend_DESeq2(), globals = c("SBC_fit.SBC_backend_DEseq2", "SBC_fit_to_draws_matrix.SBC_fit_DESeq2",
                                                          "SBC_backend_iid_samples.SBC_backend_DEseq2"),
                         cache_mode = "results", cache_location = file.path(cache_dir, "SBC_20"))
```


```{r}
pars_to_show <- paste0("beta[", sample(1:1000, size = 12), "]")
plot_rank_hist(res20, parameters = pars_to_show)
plot_ecdf_diff(res20, parameters = pars_to_show)
plot_sim_estimated(res20, parameters = pars_to_show)
plot_coverage(res20, parameters = pars_to_show)
```
```{r}
plot_ecdf_diff(res20$stats %>% mutate(parameter = "merged", dataset_id = 1:n()))
plot_rank_hist(res20$stats %>% mutate(parameter = "merged", dataset_id = 1:n()))
plot_coverage(res20$stats %>% mutate(parameter = "merged", dataset_id = 1:n()))
```


```{r}
set.seed(26845214)
datasets3 <- generate_datasets(SBC_generator_function(
   generator_single_DEseq2, N_per_group = 3, N_genes = 1000),
   n_datasets = 100) 
```


```{r}
res3 <- compute_results(datasets, SBC_backend_DESeq2(), globals = c("SBC_fit.SBC_backend_DEseq2", "SBC_fit_to_draws_matrix.SBC_fit_DESeq2",
                                                          "SBC_backend_iid_samples.SBC_backend_DEseq2"),
                         cache_mode = "results", cache_location = file.path(cache_dir, "SBC_3"))
```


```{r}
pars_to_show <- paste0("beta[", sample(1:1000, size = 12), "]")
plot_rank_hist(res3, parameters = pars_to_show)
plot_ecdf_diff(res3, parameters = pars_to_show)
plot_sim_estimated(res3, parameters = pars_to_show)
plot_coverage(res3, parameters = pars_to_show)
```


```{r}
fit <- SBC_fit(SBC_backend_DESeq2(), datasets$generated[[1]])
  res <- do.call(DESeq2::lfcShrink,
               c(list(dds = fit$dds, coef = "group_B_vs_A", 
                      type = fit$backend$shrink_type),
                 fit$backend$shrink_args))

any(is.nan(res$lfcSE))

  n_samps <- 200

  beta_samps <- matrix(res$log2FoldChange, nrow = n_samps, ncol = nrow(res),  byrow = TRUE) +
      matrix(rnorm(n_samps * nrow(res)), nrow = n_samps, ncol = nrow(res)) *
       matrix(res$lfcSE, nrow = n_samps, ncol = nrow(res),  byrow = TRUE)
```
  
  